<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Edge RAG Mini UI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script defer src="{{ url_for('static', filename='app.js') }}"></script>
</head>
<body class="{% if raw_pinned %}raw-pinned{% endif %}" style="--raw-viewer-height: {{ raw_height }}vh;">
<header>
    <h1>Edge RAG Mini Control Panel</h1>
    <p>Offline-friendly interface for ingesting documents, issuing queries, and inspecting telemetry.</p>
</header>

{% with messages = get_flashed_messages(with_categories=True) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}
<div class="log-toggle">
    <button type="button" id="log-toggle">Show Logs</button>
</div>
<aside id="log-panel" class="log-panel" aria-labelledby="log-panel-title" aria-hidden="true">
    <header class="log-panel-header">
        <h2 id="log-panel-title">System Logs</h2>
        <button type="button" id="log-close" aria-label="Close log panel">×</button>
    </header>
    <div class="log-panel-body">
        <pre id="log-stream">Logs will appear here…</pre>
    </div>
</aside>
<div id="toast-container"></div>

<section id="ingest">
    <h2>Ingest Document</h2>
    <form method="post" action="{{ url_for('ingest_document') }}">
        <fieldset>
            <legend>Document Payload</legend>
            <label for="text">Text</label>
            <textarea id="text" name="text" placeholder="Paste text you want to store" required></textarea>

            <label for="thread_id">Thread ID <small>(conversation/group identifier)</small></label>
            <input id="thread_id" name="thread_id" type="text" placeholder="default" value="default">

            <label for="annoy_id">Annoy ID (optional override)</label>
            <input id="annoy_id" name="annoy_id" type="number" min="0" step="1" placeholder="Auto when left blank">

            <div class="controls">
                <button type="submit">Ingest</button>
            </div>
        </fieldset>
    </form>
</section>

<section id="query">
    <h2>Run Query</h2>
    <form method="post" action="{{ url_for('run_query') }}">
        <fieldset>
            <legend>Query Request</legend>
            <label for="query_text">Query Text</label>
            <textarea id="query_text" name="query_text" placeholder="Ask something about stored documents" required></textarea>

            <label for="top_k">Top-K</label>
            <input id="top_k" name="top_k" type="number" min="1" step="1" value="5">

            <label for="query_thread_id">Query Thread ID <small>(defaults to ingest thread)</small></label>
            <input id="query_thread_id" name="query_thread_id" type="text" placeholder="default" value="default">

            <div class="controls">
                <button type="submit">Search</button>
            </div>
        </fieldset>
    </form>

    <div class="controls">
        <form method="post" action="{{ url_for('rebuild_index') }}" style="display:inline-block;">
            <button type="submit" class="secondary">Rebuild Index (stub)</button>
        </form>
        <form method="post" action="{{ url_for('export_data') }}" style="display:inline-block;">
            <button type="submit" class="secondary">Export Data (stub)</button>
        </form>
    </div>

    <div id="query-results" class="query-results" aria-live="polite">Top results will appear here after you run a query.</div>

    {% if last_query %}
        <article class="query-card">
            <h3>Last Query</h3>
            <p><strong>Query:</strong> {{ last_query.query_text }}</p>
            <div class="metrics">
                <span class="metric">Top-K: {{ last_query.top_k }}</span>
                <span class="metric">Embedding Time: {{ last_query.embedding_time_ms | round(2) }} ms</span>
                <span class="metric">Retrieval Time: {{ last_query.retrieval_time_ms | round(2) }} ms</span>
            </div>
            {% if last_query.results %}
                <h4>Results</h4>
                {% for result in last_query.results %}
                    <div class="query-card">
                        <p><strong>Document {{ result.doc_id }}</strong> &nbsp;•&nbsp; Thread: {{ result.thread }} &nbsp;•&nbsp; Similarity: {{ result.similarity | round(4) }}</p>
                        <div class="text-block">{{ result.text }}</div>
                        <div class="metrics">
                            <span class="metric">Embedding ms: {{ result.latency.embedding if result.latency.embedding is not none else '—' }}</span>
                            <span class="metric">Retrieval ms: {{ result.latency.retrieval if result.latency.retrieval is not none else '—' }}</span>
                            <span class="metric">Generation ms: {{ result.latency.generation if result.latency.generation is not none else '—' }}</span>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No matches found.</p>
            {% endif %}
        </article>
    {% endif %}
</section>

<section id="filters">
    <h2>Data Filters</h2>
    <form method="get" action="{{ url_for('dashboard') }}">
        <fieldset>
            <legend>Quick Filters</legend>
            <div>
                <label for="doc_thread">Document Thread contains</label>
                <input id="doc_thread" name="doc_thread" type="text" value="{{ doc_filters.thread_contains or '' }}">
            </div>
            <div>
                <label for="doc_text">Document Text contains</label>
                <input id="doc_text" name="doc_text" type="text" value="{{ doc_filters.text_contains or '' }}">
            </div>
            <div>
                <label for="log_thread">Query Log Thread contains</label>
                <input id="log_thread" name="log_thread" type="text" value="{{ log_filters.thread_contains or '' }}">
            </div>
            <div>
                <label for="log_doc_id">Query Log Matched Doc ID</label>
                <input id="log_doc_id" name="log_doc_id" type="number" min="0" step="1" value="{{ log_filters.matched_doc_id if log_filters.matched_doc_id is not none else '' }}">
            </div>
            <div class="controls">
                <button type="submit">Apply Filters</button>
                <a class="button-link" href="{{ url_for('dashboard') }}">Clear</a>
            </div>
        </fieldset>
    </form>
</section>

{# Documents table temporarily hidden to focus on raw viewer #}
<section id="documents" hidden>
    <h2>Documents ({{ documents|length }})</h2>
    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Thread</th>
                <th>Annoy ID</th>
                <th>Created</th>
                <th>Dim</th>
                <th>Embedding ms</th>
                <th>Retrieval ms</th>
                <th>Generation ms</th>
                <th>Text</th>
            </tr>
            </thead>
            <tbody>
            {% if documents %}
                {% for doc in documents %}
                    <tr>
                        <td>{{ doc.doc_id }}</td>
                        <td>{{ doc.thread_id }}</td>
                        <td>{{ doc.annoy_id }}</td>
                        <td>{{ doc.created_at }}</td>
                        <td>{{ doc.embedding_dim }}</td>
                        <td>{{ '%.3f'|format(doc.embedding_time_ms) if doc.embedding_time_ms is not none else '—' }}</td>
                        <td>{{ '%.3f'|format(doc.retrieval_time_ms) if doc.retrieval_time_ms is not none else '—' }}</td>
                        <td>{{ '%.3f'|format(doc.generation_time_ms) if doc.generation_time_ms is not none else '—' }}</td>
                        <td><div class="text-block">{{ doc.text }}</div></td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr data-empty="documents"><td colspan="9">No documents ingested yet.</td></tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</section>

{# Query logs table temporarily hidden to focus on raw viewer #}
<section id="query-logs" hidden>
    <h2>Query Logs ({{ query_logs|length }})</h2>
    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Thread</th>
                <th>Query</th>
                <th>Top-K</th>
                <th>Embedding ms</th>
                <th>Retrieval ms</th>
                <th>Generation ms</th>
                <th>Matched Doc</th>
                <th>Timestamp</th>
            </tr>
            </thead>
            <tbody>
            {% if query_logs %}
                {% for log in query_logs %}
                    <tr>
                        <td>{{ log.log_id }}</td>
                        <td>{{ log.thread_id }}</td>
                        <td>{{ log.query_text }}</td>
                        <td>{{ log.top_k }}</td>
                        <td>{{ '%.3f'|format(log.embedding_time_ms) if log.embedding_time_ms is not none else '—' }}</td>
                        <td>{{ '%.3f'|format(log.retrieval_time_ms) if log.retrieval_time_ms is not none else '—' }}</td>
                        <td>{{ '%.3f'|format(log.generation_time_ms) if log.generation_time_ms is not none else '—' }}</td>
                        <td>{{ log.matched_doc_id if log.matched_doc_id is not none else '—' }}</td>
                        <td>{{ log.queried_at }}</td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr data-empty="query_logs"><td colspan="9">No queries logged yet.</td></tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</section>

<section id="raw-viewer" class="{% if raw_pinned %}pinned{% endif %}">
    <h2>Raw Table Viewer</h2>
    <form method="get" class="raw-table-form">
        <label for="raw_table">Select table</label>
        <select id="raw_table" name="raw_table">
            {% for option in raw_table_options %}
                <option value="{{ option }}"{% if option == raw_table_choice %} selected{% endif %}>{{ option }}</option>
            {% endfor %}
        </select>
        <button type="submit" name="raw_pin_toggle" value="1" class="pin-toggle">
            {% if raw_pinned %}Unpin{% else %}Pin to Bottom{% endif %}
        </button>
        <label for="raw_height" class="height-label">Height</label>
        <input id="raw_height" name="raw_height_adjust" type="range" min="20" max="80" value="{{ raw_height }}">
        <span class="height-value">{{ raw_height }}vh</span>
        <button type="submit" name="raw_refresh" class="secondary raw-apply">Apply</button>
        <input type="hidden" name="raw_pin" value="{{ 1 if raw_pinned else 0 }}">
        <input type="hidden" name="raw_height" value="{{ raw_height }}">
        <input type="hidden" name="doc_thread" value="{{ doc_filters.thread_contains or '' }}">
        <input type="hidden" name="doc_text" value="{{ doc_filters.text_contains or '' }}">
        <input type="hidden" name="log_thread" value="{{ log_filters.thread_contains or '' }}">
        <input type="hidden" name="log_doc_id" value="{{ log_filters.matched_doc_id if log_filters.matched_doc_id is not none else '' }}">
    </form>
    <div class="raw-table-container">
        {% if raw_rows %}
            <table>
                <thead>
                <tr>
                    {% for column in raw_columns %}
                        <th>{{ column }}</th>
                    {% endfor %}
                </tr>
                </thead>
                <tbody>
                {% for row in raw_rows %}
                    <tr>
                        {% for column in raw_columns %}
                            <td>{{ row[column] }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="empty-message">No rows found in the {{ raw_table_choice }} table.</div>
        {% endif %}
    </div>
</section>
</body>
</html>
